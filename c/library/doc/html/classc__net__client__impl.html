<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>common-lib: c_net_client_impl类参考</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- 制作者 Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>首页</span></a></li>
      <li class="current"><a href="classes.html"><span>类</span></a></li>
      <li><a href="files.html"><span>文件</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="classes.html"><span>按字典顺序排序的列表</span></a></li>
      <li><a href="annotated.html"><span>组合类型列表</span></a></li>
      <li><a href="hierarchy.html"><span>类继承关系</span></a></li>
      <li><a href="functions.html"><span>组合类型成员</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>c_net_client_impl类参考</h1><!-- doxytag: class="c_net_client_impl" --><!-- doxytag: inherits="i_net_client" -->TCP网络封装的实现类  
<a href="#_details">更多...</a>
<p>
<div class="dynheader">
继承图，类c_net_client_impl</div>
<div class="dynsection">
<p><center><img src="classc__net__client__impl__inherit__graph.png" border="0" usemap="#c__net__client__impl__inherit__map" alt="Inheritance graph"></center>
<map name="c__net__client__impl__inherit__map">
<area shape="rect" href="structi__net__client.html" title="本接口提供对网络客户端的封装, 其中do_io是进行的实际的网络接收于发送..." alt="" coords="41,5,188,197"></map>
<center><font size="2">[<a href="graph_legend.html">图例</a>]</font></center></div>
<div class="dynheader">
c_net_client_impl合作图：</div>
<div class="dynsection">
<p><center><img src="classc__net__client__impl__coll__graph.png" border="0" usemap="#c__net__client__impl__coll__map" alt="Collaboration graph"></center>
<map name="c__net__client__impl__coll__map">
<area shape="rect" href="structi__net__client.html" title="本接口提供对网络客户端的封装, 其中do_io是进行的实际的网络接收于发送..." alt="" coords="41,5,188,197"></map>
<center><font size="2">[<a href="graph_legend.html">图例</a>]</font></center></div>

<p>
<a href="classc__net__client__impl-members.html">所有成员的列表。</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>公有成员</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#d3e5714f7f47dfb71e70efaf395e5e92">c_net_client_impl</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">构造函数  <a href="#d3e5714f7f47dfb71e70efaf395e5e92"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#b335ea651fa5f671d82be2299204fcfb">do_io</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">将发送缓冲中的数据发送出去,同时接收一次网络中的数据  <a href="#b335ea651fa5f671d82be2299204fcfb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#8b5fcf41ec8718e33cea00fc05dc9cb9">init</a> (int server_addr, int server_port, int timeout)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">初始化函数,建立到server的连接  <a href="#8b5fcf41ec8718e33cea00fc05dc9cb9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#abc450cc1bfab8e67af489428f2883f2">ping</a> (int timeout=0)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">尝试重新同服务端建立连接  <a href="#abc450cc1bfab8e67af489428f2883f2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#03df7c1e132110be5ffc0b0a4ddec9bb">recv_data</a> (char *p_recv_buffer, int buffer_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">接收数据  <a href="#03df7c1e132110be5ffc0b0a4ddec9bb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#b588716abfaf71209be6770d9adf65bf">release</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">对应create，释放create创建的实例  <a href="#b588716abfaf71209be6770d9adf65bf"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#bd11e3dad9cfd3fdc5214e696671c8a9">send_data</a> (char *p_data, int data_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">发送数据  <a href="#bd11e3dad9cfd3fdc5214e696671c8a9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#f822bbd25bf79cf79334fae9c581b244">send_data_atomic</a> (char *p_data, int data_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">发送数据（原子操作）  <a href="#f822bbd25bf79cf79334fae9c581b244"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#59ce4662ec1b60e5474d4e061f7a5e4b">uninit</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">反初始化 断开同服务器的连接  <a href="#59ce4662ec1b60e5474d4e061f7a5e4b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#8d329aa6182b0e2d942ad096ee3080c7">~c_net_client_impl</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">析构函数  <a href="#8d329aa6182b0e2d942ad096ee3080c7"></a><br></td></tr>
<tr><td colspan="2"><br><h2>保护成员</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#dcb594df5b127f7e46ed6b5e94d8bf05">append_data_to_send_buffer</a> (char *p_data, int data_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">将数据添加到发送缓冲的末尾  <a href="#dcb594df5b127f7e46ed6b5e94d8bf05"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#aa09a7c9ef67f68364ab3cd158785d98">connect_to_server</a> (int timeout)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">连接到服务端  <a href="#aa09a7c9ef67f68364ab3cd158785d98"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#5aebee25da11c1d25c2b37e82c572c21">disconnect_from_server</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">断开同服务端的连接  <a href="#5aebee25da11c1d25c2b37e82c572c21"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#7294273bf956c1d176d684521e3c7064">recv_data_from_server</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">从服务端接收数据  <a href="#7294273bf956c1d176d684521e3c7064"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#873e3815c99eaefdba1aef19ce0f562c">recv_from_server</a> (int fd, char *p_recv_buffer, int buffer_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">从fd上接收数据，放入缓存p_recv_buffer  <a href="#873e3815c99eaefdba1aef19ce0f562c"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#a1d1d37cadce37a94d38f4026cb3c00c">remove_data_from_recv_buffer</a> (int data_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">从接收缓存中移走数据  <a href="#a1d1d37cadce37a94d38f4026cb3c00c"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#5a08322929ff44382d4b1306bd3d99c1">remove_data_from_send_buffer</a> (int data_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">将send_buffer中的数据移走  <a href="#5a08322929ff44382d4b1306bd3d99c1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#3ae4d11a27d2561d3d3ff8fb6161d4ab">send_to_server</a> (int fd, char *p_data, int data_len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">发送数据  <a href="#3ae4d11a27d2561d3d3ff8fb6161d4ab"></a><br></td></tr>
<tr><td colspan="2"><br><h2>私有属性</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c">m_inited</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">是否初始化标志  <a href="#2ff8349ccf9ad6486506c463b6e5942c"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914">m_recv_buffer</a> [NET_CLIENT_MAX_RECV_BUFFER_LEN]</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">存放接收的数据  <a href="#9fc11565ed965285d4339820e6359914"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc">m_recv_buffer_len</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">接收缓存中的数据长度  <a href="#2e615a54215eaba3d471938d63d9a7fc"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6">m_send_buffer</a> [NET_CLIENT_MAX_SEND_BUFFER_LEN]</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">存放待发送数据  <a href="#41f584886eaeaa82c88a652b85991ab6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936">m_send_buffer_len</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">发送缓存中的数据长度  <a href="#d7b7f8dfbdfd2b328fa997aa45d41936"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#3d548e6ff64fd2ace0e2ed1b870231f6">m_server_addr</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#25010eac11040cd549e37f5881bfb590">m_server_port</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6">m_sock_fd</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">连接fd  <a href="#70638c8b79d1d190ce844d494251fec6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classc__net__client__impl.html#a86a52c60141b010f765a0cbb6bbe82b">m_timeout</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">用于控制select的超时时间(微级)  <a href="#a86a52c60141b010f765a0cbb6bbe82b"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>详细描述</h2>
TCP网络封装的实现类 <hr><h2>构造及析构函数文档</h2>
<a class="anchor" name="d3e5714f7f47dfb71e70efaf395e5e92"></a><!-- doxytag: member="c_net_client_impl::c_net_client_impl" ref="d3e5714f7f47dfb71e70efaf395e5e92" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">c_net_client_impl::c_net_client_impl           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
构造函数 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>无</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>无 </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00068"></a>00068 {
<a name="l00069"></a>00069     <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00070"></a>00070     <a class="code" href="classc__net__client__impl.html#3d548e6ff64fd2ace0e2ed1b870231f6">m_server_addr</a> = 0;
<a name="l00071"></a>00071     <a class="code" href="classc__net__client__impl.html#25010eac11040cd549e37f5881bfb590">m_server_port</a> = 0;
<a name="l00072"></a>00072     <a class="code" href="classc__net__client__impl.html#a86a52c60141b010f765a0cbb6bbe82b" title="用于控制select的超时时间(微级)">m_timeout</a> = 0;
<a name="l00073"></a>00073     <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> = 0;
<a name="l00074"></a>00074     <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> = 0;
<a name="l00075"></a>00075     <a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a> = 0;
<a name="l00076"></a>00076 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="8d329aa6182b0e2d942ad096ee3080c7"></a><!-- doxytag: member="c_net_client_impl::~c_net_client_impl" ref="8d329aa6182b0e2d942ad096ee3080c7" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">c_net_client_impl::~c_net_client_impl           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
析构函数 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>无</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>无 </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00084"></a>00084 {
<a name="l00085"></a>00085     <a class="code" href="classc__net__client__impl.html#59ce4662ec1b60e5474d4e061f7a5e4b" title="反初始化 断开同服务器的连接">uninit</a>();
<a name="l00086"></a>00086 }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>成员函数文档</h2>
<a class="anchor" name="dcb594df5b127f7e46ed6b5e94d8bf05"></a><!-- doxytag: member="c_net_client_impl::append_data_to_send_buffer" ref="dcb594df5b127f7e46ed6b5e94d8bf05" args="(char *p_data, int data_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::append_data_to_send_buffer           </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>p_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>data_len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
将数据添加到发送缓冲的末尾 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>p_data</em>&nbsp;</td><td>需添加的数据 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data_len</em>&nbsp;</td><td>待添加的数据的长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>-1 发送缓冲空间不够 &gt;=0 添加的数据长度 </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00398"></a>00398 {
<a name="l00399"></a>00399     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> + data_len &gt; (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(<a class="code" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6" title="存放待发送数据">m_send_buffer</a>))
<a name="l00400"></a>00400     {
<a name="l00401"></a>00401         <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     memcpy(<a class="code" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6" title="存放待发送数据">m_send_buffer</a> + <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a>, p_data, data_len);
<a name="l00405"></a>00405     <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> +=  data_len;
<a name="l00406"></a>00406     <span class="keywordflow">return</span> data_len;
<a name="l00407"></a>00407 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="aa09a7c9ef67f68364ab3cd158785d98"></a><!-- doxytag: member="c_net_client_impl::connect_to_server" ref="aa09a7c9ef67f68364ab3cd158785d98" args="(int timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::connect_to_server           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
连接到服务端 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td>0success -1failed </td></tr>
  </table>
</dl>
<div class="fragment"><pre class="fragment"><a name="l00590"></a>00590 {
<a name="l00591"></a>00591     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &gt; 0)
<a name="l00592"></a>00592     {
<a name="l00593"></a>00593         close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00594"></a>00594         <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> = 0;
<a name="l00598"></a>00598     <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> = 0;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = socket(AF_INET, SOCK_STREAM, 0);
<a name="l00601"></a>00601     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &lt; 0)
<a name="l00602"></a>00602     {
<a name="l00603"></a>00603         ERROR_LOG(<span class="stringliteral">"errno[%d]:%s"</span>,errno, strerror(errno));
<a name="l00604"></a>00604         <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00605"></a>00605         <span class="keywordflow">return</span> -1;
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="keyword">struct </span>sockaddr_in serv_addr;
<a name="l00609"></a>00609     memset(&amp;serv_addr, 0, <span class="keyword">sizeof</span>(serv_addr));
<a name="l00610"></a>00610     serv_addr.sin_family = AF_INET;
<a name="l00611"></a>00611     serv_addr.sin_addr.s_addr = <a class="code" href="classc__net__client__impl.html#3d548e6ff64fd2ace0e2ed1b870231f6">m_server_addr</a>;
<a name="l00612"></a>00612     serv_addr.sin_port = htons(<a class="code" href="classc__net__client__impl.html#25010eac11040cd549e37f5881bfb590">m_server_port</a>);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="keywordtype">int</span> flags = fcntl(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, F_GETFL);
<a name="l00615"></a>00615     flags |= O_NONBLOCK;
<a name="l00616"></a>00616     fcntl(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, F_SETFL, flags);
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     <span class="keywordtype">int</span> result = connect(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, (<span class="keyword">struct</span> sockaddr*)&amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr));
<a name="l00619"></a>00619     <span class="keywordflow">if</span>(result &lt; 0)
<a name="l00620"></a>00620     {
<a name="l00621"></a>00621         <span class="keywordflow">if</span>(errno == EINPROGRESS || errno == EISCONN)
<a name="l00622"></a>00622         {
<a name="l00623"></a>00623             <span class="keyword">struct </span>timeval tv;
<a name="l00624"></a>00624             <span class="keywordflow">if</span>(timeout &lt; 1000)
<a name="l00625"></a>00625             {
<a name="l00626"></a>00626                 timeout = 1000;
<a name="l00627"></a>00627             }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629             tv.tv_sec = timeout / 1000;
<a name="l00630"></a>00630             tv.tv_usec = timeout % 1000;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632             fd_set write_set, err_set;
<a name="l00633"></a>00633             FD_ZERO(&amp;write_set);
<a name="l00634"></a>00634             FD_ZERO(&amp;err_set);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636             FD_SET(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, &amp;write_set);
<a name="l00637"></a>00637             FD_SET(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, &amp;err_set);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639             <span class="keywordtype">int</span> result = select(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> + 1, NULL, &amp;write_set, &amp;err_set, &amp;tv);
<a name="l00640"></a>00640             <span class="keywordflow">if</span>(result &lt; 0)
<a name="l00641"></a>00641             {
<a name="l00642"></a>00642                 ERROR_LOG(<span class="stringliteral">"errno[%d]:%s"</span>,errno, strerror(errno));
<a name="l00643"></a>00643                 close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00644"></a>00644                 <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00645"></a>00645                 <span class="keywordflow">return</span> -1;
<a name="l00646"></a>00646             }
<a name="l00647"></a>00647             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(result == 0)
<a name="l00648"></a>00648             {
<a name="l00649"></a>00649                 ERROR_LOG(<span class="stringliteral">"timeout in select"</span>);
<a name="l00650"></a>00650                 close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00651"></a>00651                 <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00652"></a>00652                 <span class="keywordflow">return</span> -1;
<a name="l00653"></a>00653             }
<a name="l00654"></a>00654             <span class="keywordflow">else</span>
<a name="l00655"></a>00655             {
<a name="l00656"></a>00656                 <span class="keywordtype">int</span> opt = -1;
<a name="l00657"></a>00657                 socklen_t opt_len = <span class="keyword">sizeof</span>(opt);
<a name="l00658"></a>00658                 getsockopt(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, SOL_SOCKET, SO_ERROR, &amp;opt, &amp;opt_len);
<a name="l00659"></a>00659                 <span class="keywordflow">if</span>(opt)
<a name="l00660"></a>00660                 {
<a name="l00661"></a>00661                     ERROR_LOG(<span class="stringliteral">"errno[%d]:%s"</span>,errno, strerror(errno));
<a name="l00662"></a>00662                     close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00663"></a>00663                     <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00664"></a>00664                     <span class="keywordflow">return</span> -1;
<a name="l00665"></a>00665                 }
<a name="l00666"></a>00666                 <span class="keywordflow">else</span>
<a name="l00667"></a>00667                 {<span class="comment">//连接可用</span>
<a name="l00668"></a>00668                     <span class="keywordflow">return</span> 0;
<a name="l00669"></a>00669                 }
<a name="l00670"></a>00670             }
<a name="l00671"></a>00671         }
<a name="l00672"></a>00672         <span class="keywordflow">else</span>
<a name="l00673"></a>00673         {
<a name="l00674"></a>00674             ERROR_LOG(<span class="stringliteral">"errno[%d]:%s"</span>,errno, strerror(errno));
<a name="l00675"></a>00675             close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00676"></a>00676             <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00677"></a>00677             <span class="keywordflow">return</span> -1;
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(result == 0)
<a name="l00681"></a>00681     {
<a name="l00682"></a>00682         <span class="keywordflow">return</span> 0;
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     <span class="keywordflow">else</span>
<a name="l00685"></a>00685     {
<a name="l00686"></a>00686         ERROR_LOG(<span class="stringliteral">"errno[%d]:%s"</span>,errno, strerror(errno));
<a name="l00687"></a>00687         close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00688"></a>00688         <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00689"></a>00689         <span class="keywordflow">return</span> -1;
<a name="l00690"></a>00690     }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     <span class="keywordflow">return</span> 0;
<a name="l00693"></a>00693 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5aebee25da11c1d25c2b37e82c572c21"></a><!-- doxytag: member="c_net_client_impl::disconnect_from_server" ref="5aebee25da11c1d25c2b37e82c572c21" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::disconnect_from_server           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
断开同服务端的连接 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<div class="fragment"><pre class="fragment"><a name="l00701"></a>00701 {
<a name="l00702"></a>00702     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &gt;= 0)
<a name="l00703"></a>00703     {
<a name="l00704"></a>00704         close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00705"></a>00705         <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> = 0;
<a name="l00709"></a>00709     <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> = 0;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711     <span class="keywordflow">return</span> 0;
<a name="l00712"></a>00712 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b335ea651fa5f671d82be2299204fcfb"></a><!-- doxytag: member="c_net_client_impl::do_io" ref="b335ea651fa5f671d82be2299204fcfb" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::do_io           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
将发送缓冲中的数据发送出去,同时接收一次网络中的数据 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td>0success -1failed </td></tr>
  </table>
</dl>

<p>
&lt; 连接遇到问题，关闭连接 
<p>实现了<a class="el" href="structi__net__client.html#10bf7e0191880b1ac4f735cec823eb1f">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00292"></a>00292 {
<a name="l00293"></a>00293     <span class="keywordflow">if</span>(!<a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a>)
<a name="l00294"></a>00294     {
<a name="l00295"></a>00295         <span class="keywordflow">return</span> -1;
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &lt; 0)
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300         <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#aa09a7c9ef67f68364ab3cd158785d98" title="连接到服务端">connect_to_server</a>(<a class="code" href="classc__net__client__impl.html#a86a52c60141b010f765a0cbb6bbe82b" title="用于控制select的超时时间(微级)">m_timeout</a>) != 0)
<a name="l00301"></a>00301         {
<a name="l00302"></a>00302             ERROR_LOG(<span class="stringliteral">"can not connect now"</span>);
<a name="l00303"></a>00303             <span class="keywordflow">return</span> -1;
<a name="l00304"></a>00304         }    
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#7294273bf956c1d176d684521e3c7064" title="从服务端接收数据">recv_data_from_server</a>() &lt; 0)
<a name="l00308"></a>00308     {
<a name="l00309"></a>00309         <span class="keywordflow">return</span> -1;
<a name="l00310"></a>00310     }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> &gt; 0)
<a name="l00313"></a>00313     {
<a name="l00314"></a>00314         <span class="keywordtype">int</span> bytes_sent = <a class="code" href="classc__net__client__impl.html#3ae4d11a27d2561d3d3ff8fb6161d4ab" title="发送数据">send_to_server</a>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, <a class="code" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6" title="存放待发送数据">m_send_buffer</a>, <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a>);
<a name="l00315"></a>00315         <span class="keywordflow">if</span>(bytes_sent &gt; 0)
<a name="l00316"></a>00316         {
<a name="l00317"></a>00317             <a class="code" href="classc__net__client__impl.html#5a08322929ff44382d4b1306bd3d99c1" title="将send_buffer中的数据移走">remove_data_from_send_buffer</a>(bytes_sent);
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(bytes_sent &lt; 0)
<a name="l00320"></a>00320         {
<a name="l00321"></a>00321            <a class="code" href="classc__net__client__impl.html#5aebee25da11c1d25c2b37e82c572c21" title="断开同服务端的连接">disconnect_from_server</a>();
<a name="l00322"></a>00322            <span class="keywordflow">return</span> -1;
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324         <span class="keywordflow">else</span>
<a name="l00325"></a>00325         {
<a name="l00326"></a>00326             <span class="comment">//nothing to do</span>
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">return</span> 0;
<a name="l00332"></a>00332 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="8b5fcf41ec8718e33cea00fc05dc9cb9"></a><!-- doxytag: member="c_net_client_impl::init" ref="8b5fcf41ec8718e33cea00fc05dc9cb9" args="(int server_addr, int server_port, int timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::init           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>server_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>server_port</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
初始化函数,建立到server的连接 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>server_addr</em>&nbsp;</td><td>服务端的地址 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>server_port</em>&nbsp;</td><td>服务端的端口号 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>0success -1failed </dd></dl>

<p>实现了<a class="el" href="structi__net__client.html#da665651c5d156f8572350742e3d316f">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00095"></a>00095 {
<a name="l00096"></a>00096     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a>)
<a name="l00097"></a>00097     {
<a name="l00098"></a>00098         <span class="keywordflow">return</span> -1;
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100     
<a name="l00101"></a>00101     <a class="code" href="classc__net__client__impl.html#3d548e6ff64fd2ace0e2ed1b870231f6">m_server_addr</a> = server_addr;
<a name="l00102"></a>00102     <a class="code" href="classc__net__client__impl.html#25010eac11040cd549e37f5881bfb590">m_server_port</a> = server_port;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <a class="code" href="classc__net__client__impl.html#a86a52c60141b010f765a0cbb6bbe82b" title="用于控制select的超时时间(微级)">m_timeout</a> = timeout;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#aa09a7c9ef67f68364ab3cd158785d98" title="连接到服务端">connect_to_server</a>(timeout) != 0)
<a name="l00107"></a>00107     {
<a name="l00108"></a>00108         <span class="keyword">struct </span>in_addr tmp_addr;
<a name="l00109"></a>00109         memcpy(&amp;tmp_addr, &amp;server_addr, 4);
<a name="l00110"></a>00110         ERROR_LOG(<span class="stringliteral">"can not connect to server(%s: %d) now."</span>, inet_ntoa(tmp_addr), server_port);
<a name="l00111"></a>00111         <span class="keywordflow">return</span> -1;
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     <a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a> = 1;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="keywordflow">return</span> 0;
<a name="l00117"></a>00117 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="abc450cc1bfab8e67af489428f2883f2"></a><!-- doxytag: member="c_net_client_impl::ping" ref="abc450cc1bfab8e67af489428f2883f2" args="(int timeout=0)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::ping           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em> = <code>0</code>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
尝试重新同服务端建立连接 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td>0success -1failed </td></tr>
  </table>
</dl>

<p>实现了<a class="el" href="structi__net__client.html#28c326196274866fd2983b83382a4d58">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00341"></a>00341 {
<a name="l00342"></a>00342     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &lt; 0)
<a name="l00343"></a>00343     {
<a name="l00344"></a>00344         <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#aa09a7c9ef67f68364ab3cd158785d98" title="连接到服务端">connect_to_server</a>(timeout) != 0)
<a name="l00345"></a>00345         {
<a name="l00346"></a>00346             ERROR_LOG(<span class="stringliteral">"cat not connect to server"</span>);
<a name="l00347"></a>00347             <span class="keywordflow">return</span> -1;
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <span class="keywordflow">return</span> 0;
<a name="l00352"></a>00352 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="03df7c1e132110be5ffc0b0a4ddec9bb"></a><!-- doxytag: member="c_net_client_impl::recv_data" ref="03df7c1e132110be5ffc0b0a4ddec9bb" args="(char *p_recv_buffer, int buffer_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::recv_data           </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>p_recv_buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>buffer_len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
接收数据 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>p_recv_buffer</em>&nbsp;</td><td>接收缓存 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer_len</em>&nbsp;</td><td>接收缓存的长度 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>min_buffer_len</em>&nbsp;</td><td>返回消息的长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>-1无法接收数据 &gt;=0 返回数据的长度 </dd></dl>

<p>实现了<a class="el" href="structi__net__client.html#ce6261d4c5f1c593f58ef98c7242277d">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="keywordflow">if</span>(!<a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a>)
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263         <span class="keywordflow">return</span> -1;
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">if</span>(NULL == p_recv_buffer || buffer_len &lt; 0)
<a name="l00267"></a>00267     {
<a name="l00268"></a>00268         <span class="keywordflow">return</span> -1;
<a name="l00269"></a>00269     }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="keywordtype">int</span> copy_len = 0;
<a name="l00272"></a>00272     <span class="keywordflow">if</span>(buffer_len &lt; <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a>)
<a name="l00273"></a>00273     {
<a name="l00274"></a>00274         copy_len = buffer_len;
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276     <span class="keywordflow">else</span>
<a name="l00277"></a>00277     {
<a name="l00278"></a>00278         copy_len = <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a>;
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     memcpy(p_recv_buffer, <a class="code" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914" title="存放接收的数据">m_recv_buffer</a>, copy_len);
<a name="l00282"></a>00282     <a class="code" href="classc__net__client__impl.html#a1d1d37cadce37a94d38f4026cb3c00c" title="从接收缓存中移走数据">remove_data_from_recv_buffer</a>(copy_len);
<a name="l00283"></a>00283     <span class="keywordflow">return</span> copy_len;
<a name="l00284"></a>00284 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7294273bf956c1d176d684521e3c7064"></a><!-- doxytag: member="c_net_client_impl::recv_data_from_server" ref="7294273bf956c1d176d684521e3c7064" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::recv_data_from_server           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
从服务端接收数据 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td>-1无法接收数据 &gt;0 接收到的数据长度 </td></tr>
  </table>
</dl>

<p>
&lt; 检查是否有足够的空间接收继续数据 <div class="fragment"><pre class="fragment"><a name="l00477"></a>00477 {
<a name="l00478"></a>00478     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> &gt;= (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(<a class="code" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914" title="存放接收的数据">m_recv_buffer</a>))
<a name="l00479"></a>00479     {
<a name="l00480"></a>00480         <span class="keywordflow">return</span> 0;
<a name="l00481"></a>00481     }    
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keywordtype">int</span> bytes_recved = <a class="code" href="classc__net__client__impl.html#873e3815c99eaefdba1aef19ce0f562c" title="从fd上接收数据，放入缓存p_recv_buffer">recv_from_server</a>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, <a class="code" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914" title="存放接收的数据">m_recv_buffer</a> + <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a>, <span class="keyword">sizeof</span>(<a class="code" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914" title="存放接收的数据">m_recv_buffer</a>) - <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a>);
<a name="l00484"></a>00484     <span class="keywordflow">if</span>(bytes_recved &lt; 0)
<a name="l00485"></a>00485     {
<a name="l00486"></a>00486         <a class="code" href="classc__net__client__impl.html#5aebee25da11c1d25c2b37e82c572c21" title="断开同服务端的连接">disconnect_from_server</a>();
<a name="l00487"></a>00487         <span class="keywordflow">return</span> -1;
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(bytes_recved == 0)
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491         <span class="comment">//nothing to do</span>
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493     <span class="keywordflow">else</span>
<a name="l00494"></a>00494     {
<a name="l00495"></a>00495         <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> += bytes_recved;
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="keywordflow">return</span> bytes_recved;
<a name="l00499"></a>00499 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="873e3815c99eaefdba1aef19ce0f562c"></a><!-- doxytag: member="c_net_client_impl::recv_from_server" ref="873e3815c99eaefdba1aef19ce0f562c" args="(int fd, char *p_recv_buffer, int buffer_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::recv_from_server           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>p_recv_buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>buffer_len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
从fd上接收数据，放入缓存p_recv_buffer 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>fd</em>&nbsp;</td><td>连接fd </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>p_recv_buffer</em>&nbsp;</td><td>接收缓存 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer_len</em>&nbsp;</td><td>接收缓存的长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>-1无法接收数据 0接收过程被中断 &gt;0接收到数据长度 </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00510"></a>00510 {
<a name="l00511"></a>00511     <span class="keywordflow">if</span>(buffer_len &lt;= 0)
<a name="l00512"></a>00512     {
<a name="l00513"></a>00513         <span class="keywordflow">return</span> -1;
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     fd_set read_fd;
<a name="l00517"></a>00517     FD_ZERO(&amp;read_fd);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     FD_SET(fd, &amp;read_fd);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keyword">struct </span>timeval tv;
<a name="l00522"></a>00522     tv.tv_sec = 0;
<a name="l00523"></a>00523     tv.tv_usec = 1;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="keywordtype">int</span> result = select(fd + 1, &amp;read_fd, NULL, NULL, &amp;tv);
<a name="l00526"></a>00526     <span class="keywordflow">if</span>(result &lt; 0)
<a name="l00527"></a>00527     {
<a name="l00528"></a>00528         <span class="keywordflow">return</span> -1; 
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(result == 0)
<a name="l00531"></a>00531     {<span class="comment">//no data on socket</span>
<a name="l00532"></a>00532         <span class="keywordflow">return</span> 0;
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534     <span class="keywordflow">else</span>
<a name="l00535"></a>00535     {
<a name="l00536"></a>00536         <span class="keywordtype">int</span> bytes_recved = recv(fd, p_recv_buffer, buffer_len, 0);
<a name="l00537"></a>00537         <span class="keywordflow">if</span>(bytes_recved &gt; 0)
<a name="l00538"></a>00538         {
<a name="l00539"></a>00539             <span class="keywordflow">return</span> bytes_recved;
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(bytes_recved == 0)
<a name="l00542"></a>00542         {
<a name="l00543"></a>00543             <span class="keywordflow">return</span> -1;
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545         <span class="keywordflow">else</span>
<a name="l00546"></a>00546         {
<a name="l00547"></a>00547             <span class="keywordflow">if</span>(errno == EAGAIN || errno == EINTR)
<a name="l00548"></a>00548             {
<a name="l00549"></a>00549                 <span class="keywordflow">return</span> 0;
<a name="l00550"></a>00550             }
<a name="l00551"></a>00551             <span class="keywordflow">else</span>
<a name="l00552"></a>00552             {
<a name="l00553"></a>00553                 <span class="keywordflow">return</span> -1;
<a name="l00554"></a>00554             }
<a name="l00555"></a>00555         }
<a name="l00556"></a>00556     }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b588716abfaf71209be6770d9adf65bf"></a><!-- doxytag: member="c_net_client_impl::release" ref="b588716abfaf71209be6770d9adf65bf" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::release           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
对应create，释放create创建的实例 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td></td></tr>
  </table>
</dl>

<p>实现了<a class="el" href="structi__net__client.html#f40cfddb24f9526a0704be8a33d95def">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00386"></a>00386 {
<a name="l00387"></a>00387     <span class="keyword">delete</span> <span class="keyword">this</span>;
<a name="l00388"></a>00388     <span class="keywordflow">return</span> 0;
<a name="l00389"></a>00389 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a1d1d37cadce37a94d38f4026cb3c00c"></a><!-- doxytag: member="c_net_client_impl::remove_data_from_recv_buffer" ref="a1d1d37cadce37a94d38f4026cb3c00c" args="(int data_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::remove_data_from_recv_buffer           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>data_len</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
从接收缓存中移走数据 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data_len</em>&nbsp;</td><td>需要移走的数据长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd></dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00566"></a>00566 {
<a name="l00567"></a>00567     <span class="keywordflow">if</span>(data_len &gt; <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a>)
<a name="l00568"></a>00568     {
<a name="l00569"></a>00569         <span class="keywordflow">return</span> -1;
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(data_len == <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a>)
<a name="l00572"></a>00572     {
<a name="l00573"></a>00573         <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> = 0;
<a name="l00574"></a>00574         <span class="keywordflow">return</span> data_len;
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576     <span class="keywordflow">else</span>
<a name="l00577"></a>00577     {
<a name="l00578"></a>00578         memmove(<a class="code" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914" title="存放接收的数据">m_recv_buffer</a>, <a class="code" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914" title="存放接收的数据">m_recv_buffer</a> + data_len, <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> - data_len);
<a name="l00579"></a>00579         <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> -= data_len;
<a name="l00580"></a>00580         <span class="keywordflow">return</span> data_len;
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5a08322929ff44382d4b1306bd3d99c1"></a><!-- doxytag: member="c_net_client_impl::remove_data_from_send_buffer" ref="5a08322929ff44382d4b1306bd3d99c1" args="(int data_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::remove_data_from_send_buffer           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>data_len</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
将send_buffer中的数据移走 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data_len</em>&nbsp;</td><td>需要移走的数据的长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>-1failed &gt;0 移走的数据长度 </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00452"></a>00452 {
<a name="l00453"></a>00453     <span class="keywordflow">if</span>(data_len &gt; <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a>)
<a name="l00454"></a>00454     {
<a name="l00455"></a>00455         <span class="keywordflow">return</span> -1;
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(data_len == <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a>)
<a name="l00458"></a>00458     {
<a name="l00459"></a>00459         <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> = 0;
<a name="l00460"></a>00460         <span class="keywordflow">return</span> data_len;
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462     <span class="keywordflow">else</span>
<a name="l00463"></a>00463     {
<a name="l00464"></a>00464         memmove(<a class="code" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6" title="存放待发送数据">m_send_buffer</a>, <a class="code" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6" title="存放待发送数据">m_send_buffer</a> + data_len, <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> - data_len);
<a name="l00465"></a>00465         <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> -= data_len;
<a name="l00466"></a>00466         <span class="keywordflow">return</span> data_len;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="bd11e3dad9cfd3fdc5214e696671c8a9"></a><!-- doxytag: member="c_net_client_impl::send_data" ref="bd11e3dad9cfd3fdc5214e696671c8a9" args="(char *p_data, int data_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::send_data           </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>p_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>data_len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
发送数据 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>p_data</em>&nbsp;</td><td>待发送的数据 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data_len</em>&nbsp;</td><td>待发送的数据的长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>0success -1failed </dd></dl>

<p>
&lt; 发送缓冲中尚有数据，需首先将本次数据添加到发送缓冲中，然后再调用发送函数<p>
&lt; 连接遇到问题，关闭连接<p>
&lt; 无法发送数据 nothing to do<p>
&lt; 发送缓冲为空，直接调用发送函数 
<p>实现了<a class="el" href="structi__net__client.html#1bc1f6e02e12e5bc04c49102f6ea3bbe">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00127"></a>00127 {
<a name="l00128"></a>00128     <span class="keywordflow">if</span>(!<a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a>)
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130         <span class="keywordflow">return</span> -1;
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="keywordflow">if</span>(NULL == p_data || data_len &lt; 0)
<a name="l00134"></a>00134     {
<a name="l00135"></a>00135         <span class="keywordflow">return</span> -1;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &lt; 0)
<a name="l00139"></a>00139     {
<a name="l00140"></a>00140         <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#aa09a7c9ef67f68364ab3cd158785d98" title="连接到服务端">connect_to_server</a>(<a class="code" href="classc__net__client__impl.html#a86a52c60141b010f765a0cbb6bbe82b" title="用于控制select的超时时间(微级)">m_timeout</a>) &lt; 0)
<a name="l00141"></a>00141         {
<a name="l00142"></a>00142             ERROR_LOG(<span class="stringliteral">"can not connect to server now."</span>);
<a name="l00143"></a>00143             <span class="keywordflow">return</span> -1;
<a name="l00144"></a>00144         }
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> &gt; 0)
<a name="l00148"></a>00148     {
<a name="l00149"></a>00149         <span class="keywordflow">if</span>(data_len &gt; 0)
<a name="l00150"></a>00150         {
<a name="l00151"></a>00151             <a class="code" href="classc__net__client__impl.html#dcb594df5b127f7e46ed6b5e94d8bf05" title="将数据添加到发送缓冲的末尾">append_data_to_send_buffer</a>(p_data, data_len);
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153         
<a name="l00154"></a>00154         <span class="keywordtype">int</span> bytes_sent = <a class="code" href="classc__net__client__impl.html#3ae4d11a27d2561d3d3ff8fb6161d4ab" title="发送数据">send_to_server</a>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, <a class="code" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6" title="存放待发送数据">m_send_buffer</a>, <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a>);
<a name="l00155"></a>00155         <span class="keywordflow">if</span>(bytes_sent &gt; 0)
<a name="l00156"></a>00156         {
<a name="l00157"></a>00157             <a class="code" href="classc__net__client__impl.html#5a08322929ff44382d4b1306bd3d99c1" title="将send_buffer中的数据移走">remove_data_from_send_buffer</a>(bytes_sent);
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(bytes_sent &lt; 0)
<a name="l00160"></a>00160         {
<a name="l00161"></a>00161            <a class="code" href="classc__net__client__impl.html#5aebee25da11c1d25c2b37e82c572c21" title="断开同服务端的连接">disconnect_from_server</a>();
<a name="l00162"></a>00162            <span class="keywordflow">return</span> -1;
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164         <span class="keywordflow">else</span>
<a name="l00165"></a>00165         {
<a name="l00167"></a>00167         }
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169     <span class="keywordflow">else</span>
<a name="l00170"></a>00170     {
<a name="l00171"></a>00171        <span class="keywordflow">if</span>(data_len &gt; 0)
<a name="l00172"></a>00172        {
<a name="l00173"></a>00173             <span class="keywordtype">int</span> bytes_sent = <a class="code" href="classc__net__client__impl.html#3ae4d11a27d2561d3d3ff8fb6161d4ab" title="发送数据">send_to_server</a>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, p_data, data_len);
<a name="l00174"></a>00174             <span class="keywordflow">if</span>(bytes_sent &gt;= 0)
<a name="l00175"></a>00175             {
<a name="l00176"></a>00176                 <span class="keywordflow">if</span>(bytes_sent &lt; data_len)
<a name="l00177"></a>00177                 {
<a name="l00178"></a>00178                     <a class="code" href="classc__net__client__impl.html#dcb594df5b127f7e46ed6b5e94d8bf05" title="将数据添加到发送缓冲的末尾">append_data_to_send_buffer</a>(p_data + bytes_sent, data_len -bytes_sent);
<a name="l00179"></a>00179                 }
<a name="l00180"></a>00180             }
<a name="l00181"></a>00181             <span class="keywordflow">else</span>
<a name="l00182"></a>00182             {
<a name="l00183"></a>00183                 <a class="code" href="classc__net__client__impl.html#5aebee25da11c1d25c2b37e82c572c21" title="断开同服务端的连接">disconnect_from_server</a>();
<a name="l00184"></a>00184                 <span class="keywordflow">return</span> -1;
<a name="l00185"></a>00185             }
<a name="l00186"></a>00186        }
<a name="l00187"></a>00187        <span class="keywordflow">else</span>
<a name="l00188"></a>00188        {
<a name="l00189"></a>00189             <span class="comment">//nothing to do</span>
<a name="l00190"></a>00190        }
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="keywordflow">return</span> 0;
<a name="l00194"></a>00194 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f822bbd25bf79cf79334fae9c581b244"></a><!-- doxytag: member="c_net_client_impl::send_data_atomic" ref="f822bbd25bf79cf79334fae9c581b244" args="(char *p_data, int data_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::send_data_atomic           </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>p_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>data_len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
发送数据（原子操作） 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>p_data</em>&nbsp;</td><td>待发送的数据 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data_len</em>&nbsp;</td><td>待发送的数据长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>0success -1failed </dd></dl>

<p>
&lt; 发送缓冲为空 
<p>实现了<a class="el" href="structi__net__client.html#38613529c78e908e6920a44373942703">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00204"></a>00204 {
<a name="l00205"></a>00205     <span class="keywordflow">if</span>(!<a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a>)
<a name="l00206"></a>00206     {
<a name="l00207"></a>00207         <span class="keywordflow">return</span> -1;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordflow">if</span>(NULL == p_data || data_len &lt; 0)
<a name="l00211"></a>00211     {
<a name="l00212"></a>00212         <span class="keywordflow">return</span> -1;
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &lt; 0)
<a name="l00216"></a>00216     {
<a name="l00217"></a>00217         <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#aa09a7c9ef67f68364ab3cd158785d98" title="连接到服务端">connect_to_server</a>(<a class="code" href="classc__net__client__impl.html#a86a52c60141b010f765a0cbb6bbe82b" title="用于控制select的超时时间(微级)">m_timeout</a>) &lt; 0)
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219             ERROR_LOG(<span class="stringliteral">"can not connect to server now."</span>);
<a name="l00220"></a>00220             <span class="keywordflow">return</span> -1;
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222     }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     <span class="keywordtype">int</span> empty_data_len = <span class="keyword">sizeof</span>(<a class="code" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6" title="存放待发送数据">m_send_buffer</a>) - <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a>;
<a name="l00225"></a>00225     <span class="keywordflow">if</span>(empty_data_len &lt; data_len)
<a name="l00226"></a>00226     {
<a name="l00227"></a>00227         ERROR_LOG(<span class="stringliteral">"It doesn't have enough space"</span>);
<a name="l00228"></a>00228         <span class="keywordflow">return</span> -1;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keywordtype">int</span> bytes_sent = 0;
<a name="l00232"></a>00232     <span class="keywordtype">int</span> remain_data_len = 0;
<a name="l00233"></a>00233     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> == 0) 
<a name="l00234"></a>00234     {
<a name="l00235"></a>00235         bytes_sent = <a class="code" href="classc__net__client__impl.html#3ae4d11a27d2561d3d3ff8fb6161d4ab" title="发送数据">send_to_server</a>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>, p_data, data_len);
<a name="l00236"></a>00236         <span class="keywordflow">if</span>(bytes_sent &gt;= 0)
<a name="l00237"></a>00237         {
<a name="l00238"></a>00238             remain_data_len = data_len - bytes_sent;
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="keywordflow">if</span>(remain_data_len == 0)
<a name="l00243"></a>00243     {
<a name="l00244"></a>00244         <span class="keywordflow">return</span> 0;
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <a class="code" href="classc__net__client__impl.html#dcb594df5b127f7e46ed6b5e94d8bf05" title="将数据添加到发送缓冲的末尾">append_data_to_send_buffer</a>(p_data + bytes_sent, remain_data_len);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="keywordflow">return</span> 0;
<a name="l00250"></a>00250 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3ae4d11a27d2561d3d3ff8fb6161d4ab"></a><!-- doxytag: member="c_net_client_impl::send_to_server" ref="3ae4d11a27d2561d3d3ff8fb6161d4ab" args="(int fd, char *p_data, int data_len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::send_to_server           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>p_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>data_len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
发送数据 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>fd</em>&nbsp;</td><td>sockfd </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>p_data</em>&nbsp;</td><td>指向待发送的数据 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data_len</em>&nbsp;</td><td>待发送的数据长度 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>返回:</b></dt><dd>-1failed 0发送被中断 &gt;0发送出去的数据长度 </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00417"></a>00417 {
<a name="l00418"></a>00418     <span class="keywordflow">if</span>(data_len &lt;= 0)
<a name="l00419"></a>00419     {
<a name="l00420"></a>00420         <span class="keywordflow">return</span> -1;
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <span class="keywordtype">int</span> bytes_sent = send(fd, p_data, data_len, 0);
<a name="l00424"></a>00424     <span class="keywordflow">if</span>(bytes_sent &gt; 0)
<a name="l00425"></a>00425     {
<a name="l00426"></a>00426         <span class="keywordflow">return</span> bytes_sent;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(bytes_sent == 0)
<a name="l00429"></a>00429     {
<a name="l00430"></a>00430        <span class="keywordflow">return</span> -1; 
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432     <span class="keywordflow">else</span>
<a name="l00433"></a>00433     {
<a name="l00434"></a>00434         <span class="keywordflow">if</span>(errno == EAGAIN || errno == EINTR)
<a name="l00435"></a>00435         {
<a name="l00436"></a>00436             <span class="keywordflow">return</span> 0;
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438         <span class="keywordflow">else</span>
<a name="l00439"></a>00439         {
<a name="l00440"></a>00440             <span class="keywordflow">return</span> -1;
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="59ce4662ec1b60e5474d4e061f7a5e4b"></a><!-- doxytag: member="c_net_client_impl::uninit" ref="59ce4662ec1b60e5474d4e061f7a5e4b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int c_net_client_impl::uninit           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
反初始化 断开同服务器的连接 
<p>
<dl compact><dt><b>参数:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td>0success -1failed </td></tr>
  </table>
</dl>

<p>实现了<a class="el" href="structi__net__client.html#ab41786093c28bf1d01a93258f83b2de">i_net_client</a>。</p>
<div class="fragment"><pre class="fragment"><a name="l00360"></a>00360 {
<a name="l00361"></a>00361     <span class="keywordflow">if</span>(!<a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a>)
<a name="l00362"></a>00362     {
<a name="l00363"></a>00363         <span class="keywordflow">return</span> -1;
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <span class="keywordflow">if</span>(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> &gt;= 0)
<a name="l00367"></a>00367     {
<a name="l00368"></a>00368         close(<a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a>);
<a name="l00369"></a>00369         <a class="code" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6" title="连接fd">m_sock_fd</a> = -1;
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371     
<a name="l00372"></a>00372     
<a name="l00373"></a>00373     <a class="code" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936" title="发送缓存中的数据长度">m_send_buffer_len</a> = 0;
<a name="l00374"></a>00374     <a class="code" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc" title="接收缓存中的数据长度">m_recv_buffer_len</a> = 0;
<a name="l00375"></a>00375     <a class="code" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c" title="是否初始化标志">m_inited</a> = 0;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="keywordflow">return</span> 0;
<a name="l00378"></a>00378 }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>成员数据文档</h2>
<a class="anchor" name="2ff8349ccf9ad6486506c463b6e5942c"></a><!-- doxytag: member="c_net_client_impl::m_inited" ref="2ff8349ccf9ad6486506c463b6e5942c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classc__net__client__impl.html#2ff8349ccf9ad6486506c463b6e5942c">c_net_client_impl::m_inited</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
是否初始化标志 
<p>

</div>
</div><p>
<a class="anchor" name="9fc11565ed965285d4339820e6359914"></a><!-- doxytag: member="c_net_client_impl::m_recv_buffer" ref="9fc11565ed965285d4339820e6359914" args="[NET_CLIENT_MAX_RECV_BUFFER_LEN]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="classc__net__client__impl.html#9fc11565ed965285d4339820e6359914">c_net_client_impl::m_recv_buffer</a>[NET_CLIENT_MAX_RECV_BUFFER_LEN]<code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
存放接收的数据 
<p>

</div>
</div><p>
<a class="anchor" name="2e615a54215eaba3d471938d63d9a7fc"></a><!-- doxytag: member="c_net_client_impl::m_recv_buffer_len" ref="2e615a54215eaba3d471938d63d9a7fc" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classc__net__client__impl.html#2e615a54215eaba3d471938d63d9a7fc">c_net_client_impl::m_recv_buffer_len</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
接收缓存中的数据长度 
<p>

</div>
</div><p>
<a class="anchor" name="41f584886eaeaa82c88a652b85991ab6"></a><!-- doxytag: member="c_net_client_impl::m_send_buffer" ref="41f584886eaeaa82c88a652b85991ab6" args="[NET_CLIENT_MAX_SEND_BUFFER_LEN]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="classc__net__client__impl.html#41f584886eaeaa82c88a652b85991ab6">c_net_client_impl::m_send_buffer</a>[NET_CLIENT_MAX_SEND_BUFFER_LEN]<code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
存放待发送数据 
<p>

</div>
</div><p>
<a class="anchor" name="d7b7f8dfbdfd2b328fa997aa45d41936"></a><!-- doxytag: member="c_net_client_impl::m_send_buffer_len" ref="d7b7f8dfbdfd2b328fa997aa45d41936" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classc__net__client__impl.html#d7b7f8dfbdfd2b328fa997aa45d41936">c_net_client_impl::m_send_buffer_len</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
发送缓存中的数据长度 
<p>

</div>
</div><p>
<a class="anchor" name="3d548e6ff64fd2ace0e2ed1b870231f6"></a><!-- doxytag: member="c_net_client_impl::m_server_addr" ref="3d548e6ff64fd2ace0e2ed1b870231f6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classc__net__client__impl.html#3d548e6ff64fd2ace0e2ed1b870231f6">c_net_client_impl::m_server_addr</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="25010eac11040cd549e37f5881bfb590"></a><!-- doxytag: member="c_net_client_impl::m_server_port" ref="25010eac11040cd549e37f5881bfb590" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classc__net__client__impl.html#25010eac11040cd549e37f5881bfb590">c_net_client_impl::m_server_port</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="70638c8b79d1d190ce844d494251fec6"></a><!-- doxytag: member="c_net_client_impl::m_sock_fd" ref="70638c8b79d1d190ce844d494251fec6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classc__net__client__impl.html#70638c8b79d1d190ce844d494251fec6">c_net_client_impl::m_sock_fd</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
连接fd 
<p>

</div>
</div><p>
<a class="anchor" name="a86a52c60141b010f765a0cbb6bbe82b"></a><!-- doxytag: member="c_net_client_impl::m_timeout" ref="a86a52c60141b010f765a0cbb6bbe82b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classc__net__client__impl.html#a86a52c60141b010f765a0cbb6bbe82b">c_net_client_impl::m_timeout</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
用于控制select的超时时间(微级) 
<p>

</div>
</div><p>
<hr>该类的文档由以下文件生成：<ul>
<li>E:/aw/svn/standard/c/library/net-client-1.0.0/<a class="el" href="net__client__impl_8h.html">net_client_impl.h</a><li>E:/aw/svn/standard/c/library/net-client-1.0.0/<a class="el" href="net__client__impl_8cpp.html">net_client_impl.cpp</a></ul>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated at Mon Jul 5 10:39:03 2010 for common-lib by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
