<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Card Class Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Card Class Reference</h1><!-- doxytag: class="Card" -->执行游戏逻辑  
<a href="#_details">More...</a>
<p>
<code>#include &lt;card.hpp&gt;</code>
<p>

<p>
<a href="class_card-members.html">List of all members.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_card.html#e690a174f1fec918efe3d77008d11513">Card</a> (game_group_t *grp)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">卡牌类构造函数  <a href="#e690a174f1fec918efe3d77008d11513"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_card.html#be5f4a27ba9431dfe6f17829a7d75cf4">setup</a> (<a class="el" href="structgame__info.html">player_game_info_t</a> *p1, <a class="el" href="structgame__info.html">player_game_info_t</a> *p2, <a class="el" href="structcard.html">card_t</a>(*all_cards)[CARD_ID_MAX])</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">设置进行本次游戏的玩家卡牌信息,设置完成后产生双方卡牌队列各12张  <a href="#be5f4a27ba9431dfe6f17829a7d75cf4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_card.html#eba1a93b3210116aaf8d8617f43b256c">handle_data</a> (sprite_t *p, int cmd, const uint8_t body[], int len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">处理玩家用户游戏通讯  <a href="#eba1a93b3210116aaf8d8617f43b256c"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_card.html#af30d52f74620a4c46106e44798cc691">handle_db_return</a> (sprite_t *p, uint32_t id, const void *buf, int len, uint32_t ret_code)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">竞赛模式提交胜负后，处理数据库返回结果  <a href="#af30d52f74620a4c46106e44798cc691"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_card.html#22cc18afb326153b46c32c177b3cc953">handle_timeout</a> (void *data)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
执行游戏逻辑 <hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="e690a174f1fec918efe3d77008d11513"></a><!-- doxytag: member="Card::Card" ref="e690a174f1fec918efe3d77008d11513" args="(game_group_t *grp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Card::Card           </td>
          <td>(</td>
          <td class="paramtype">game_group_t *&nbsp;</td>
          <td class="paramname"> <em>grp</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
卡牌类构造函数 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>玩家所在用户组</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd></dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00019"></a>00019                             : player_num(-1), final_winner(-1), owner(-1),event_owner(0),event_now(0),return_cnt(0), m_grp(grp) 
<a name="l00020"></a>00020 {
<a name="l00021"></a>00021         player[0] = NULL;
<a name="l00022"></a>00022         player[1] = NULL;
<a name="l00023"></a>00023         <span class="keywordflow">if</span> ( CHALLENGE_GAME (m_grp-&gt;game)) {
<a name="l00024"></a>00024                 player_num               = single_player;
<a name="l00025"></a>00025                 player[computer] = <span class="keyword">new</span> <a class="code" href="structgame__info.html">player_game_info_t</a>;
<a name="l00026"></a>00026                 player[computer]-&gt;<a class="code" href="structgame__info.html#8e0f2ff770e2ce422da3324820b8814a">player</a>                = NULL;
<a name="l00027"></a>00027                 player[computer]-&gt;<a class="code" href="structgame__info.html#ffff10e7d2ee399fa9f483db61664f8d">p_cards_info</a>  = NULL;
<a name="l00028"></a>00028                 
<a name="l00029"></a>00029                 <span class="keywordtype">int</span> can_win = (int)(2.0 * rand()/(RAND_MAX + 1.0));
<a name="l00030"></a>00030                 <span class="keywordflow">if</span> (can_win == 1) {
<a name="l00031"></a>00031                         final_winner = player1;
<a name="l00032"></a>00032                 }
<a name="l00033"></a>00033         } <span class="keywordflow">else</span> {
<a name="l00034"></a>00034                 player_num = multi_players;
<a name="l00035"></a>00035         }
<a name="l00036"></a>00036         DEBUG_LOG(<span class="stringliteral">"%llu\tCARD CONSTRUCT"</span>, grp-&gt;id);
<a name="l00037"></a>00037 
<a name="l00038"></a>00038         <span class="comment">//register event handler</span>
<a name="l00039"></a>00039         event_impl[0] = &amp;Card::event_none;
<a name="l00040"></a>00040         event_impl[1] = &amp;Card::self_add_one; 
<a name="l00041"></a>00041         event_impl[2] = &amp;Card::rival_minus_one;
<a name="l00042"></a>00042         event_impl[3] = &amp;Card::self_add_three;
<a name="l00043"></a>00043         event_impl[4] = &amp;Card::rival_minus_three;
<a name="l00044"></a>00044         event_impl[5] = &amp;Card::self_add_five;
<a name="l00045"></a>00045         event_impl[6] = &amp;Card::rival_minus_five;
<a name="l00046"></a>00046         event_impl[7] = &amp;Card::self_max;
<a name="l00047"></a>00047         event_impl[8] = &amp;Card::rival_min;
<a name="l00048"></a>00048         event_impl[9] = &amp;Card::rival_wood_ban;
<a name="l00049"></a>00049         event_impl[10] = &amp;Card::rival_fire_ban;
<a name="l00050"></a>00050         event_impl[11] = &amp;Card::rival_water_ban;
<a name="l00051"></a>00051         event_impl[12] = &amp;Card::exchange;
<a name="l00052"></a>00052         event_impl[13] = &amp;Card::rival_turn_wood;
<a name="l00053"></a>00053         event_impl[14] = &amp;Card::rival_turn_fire;
<a name="l00054"></a>00054         event_impl[15] = &amp;Card::rival_turn_water;
<a name="l00055"></a>00055         event_impl[16] = &amp;Card::rival_lose;
<a name="l00056"></a>00056 }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="be5f4a27ba9431dfe6f17829a7d75cf4"></a><!-- doxytag: member="Card::setup" ref="be5f4a27ba9431dfe6f17829a7d75cf4" args="(player_game_info_t *p1, player_game_info_t *p2, card_t(*all_cards)[CARD_ID_MAX])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int Card::setup           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structgame__info.html">player_game_info_t</a> *&nbsp;</td>
          <td class="paramname"> <em>p1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structgame__info.html">player_game_info_t</a> *&nbsp;</td>
          <td class="paramname"> <em>p2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structcard.html">card_t</a>(*)&nbsp;</td>
          <td class="paramname"> <em>all_cards</em>[CARD_ID_MAX]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
设置进行本次游戏的玩家卡牌信息,设置完成后产生双方卡牌队列各12张 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>player_game_info_t</em>&nbsp;</td><td>*p1 玩家1 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>player_game_info_t</em>&nbsp;</td><td>*p2 玩家2 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>card_t</em>&nbsp;</td><td>(*all_cards)[CARD_ID_MAX] 全局的标准卡牌信息 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd></dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00630"></a>00630 {
<a name="l00631"></a>00631         <span class="keywordflow">if</span> (all_cards != NULL) {
<a name="l00632"></a>00632                 cards_info = all_cards;
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634         <span class="keywordflow">if</span> ( p1 != NULL) {
<a name="l00635"></a>00635                 player[0] = p1;
<a name="l00636"></a>00636                 DEBUG_LOG(<span class="stringliteral">"%llu\tSETUP P1 %d"</span>, m_grp-&gt;id, p1-&gt;<a class="code" href="structgame__info.html#8e0f2ff770e2ce422da3324820b8814a">player</a>-&gt;id);
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638         <span class="keywordflow">if</span> ( p2 != NULL) {
<a name="l00639"></a>00639                 player[1] = p2;
<a name="l00640"></a>00640                 DEBUG_LOG(<span class="stringliteral">"%llu\tSETUP P2 %d"</span>, m_grp-&gt;id, p2-&gt;<a class="code" href="structgame__info.html#8e0f2ff770e2ce422da3324820b8814a">player</a>-&gt;id);
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642         <span class="keywordflow">if</span> (player[0] &amp;&amp; player[1]) {
<a name="l00643"></a>00643                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00644"></a>00644                         uint32_t msg[2];
<a name="l00645"></a>00645                         msg[0] = 1;
<a name="l00646"></a>00646                         msg[1] = m_grp-&gt;players[i]-&gt;id;
<a name="l00647"></a>00647                         <span class="keywordtype">int</span> msglog_type = STATISTIC_TYPE + m_grp-&gt;game-&gt;id;
<a name="l00648"></a>00648                         <span class="comment">//DEBUG_LOG("msglog %x", msglog_type);</span>
<a name="l00649"></a>00649                         <span class="keywordtype">int</span> msgret = msglog(statistic_file, msglog_type, get_now_tv()-&gt;tv_sec, &amp;msg, <span class="keyword">sizeof</span> (msg));
<a name="l00650"></a>00650                         <span class="keywordflow">if</span> (msgret != 0) {
<a name="l00651"></a>00651                                 ERROR_LOG( <span class="stringliteral">"statistic log error: message type(%x)"</span>,msglog_type);
<a name="l00652"></a>00652                         }
<a name="l00653"></a>00653                 }
<a name="l00654"></a>00654                 <span class="keywordflow">return</span> create_cards_array();
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="comment">//              DEBUG_LOG("player :1, %d; 2, %d", p1-&gt;player-&gt;id, p2-&gt;player-&gt;id);</span>
<a name="l00657"></a>00657         }
<a name="l00658"></a>00658         <span class="keywordflow">return</span> 0;
<a name="l00659"></a>00659 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<p><center><img src="class_card_be5f4a27ba9431dfe6f17829a7d75cf4_icgraph.png" border="0" usemap="#class_card_be5f4a27ba9431dfe6f17829a7d75cf4_icgraph_map" alt=""></center>
<map name="class_card_be5f4a27ba9431dfe6f17829a7d75cf4_icgraph_map">
<area shape="rect" href="class_match.html#6073642a600e0eb0d1d81d2f01301558" title="处理数据库返回的玩家卡牌库信息" alt="" coords="143,5,305,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="eba1a93b3210116aaf8d8617f43b256c"></a><!-- doxytag: member="Card::handle_data" ref="eba1a93b3210116aaf8d8617f43b256c" args="(sprite_t *p, int cmd, const uint8_t body[], int len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int Card::handle_data           </td>
          <td>(</td>
          <td class="paramtype">sprite_t *&nbsp;</td>
          <td class="paramname"> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint8_t&nbsp;</td>
          <td class="paramname"> <em>body</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
处理玩家用户游戏通讯 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td>返回GER_end_of_game结束游戏,返回0游戏继续 </td></tr>
  </table>
</dl>
<div class="fragment"><pre class="fragment"><a name="l00074"></a>00074 {
<a name="l00075"></a>00075         <span class="keywordflow">if</span> (player[0] &amp;&amp; player[1]) {
<a name="l00076"></a>00076                 <span class="keywordflow">if</span> ( p == player[0]-&gt;player) {
<a name="l00077"></a>00077                         owner = player1;
<a name="l00078"></a>00078                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (player_num == multi_players) {
<a name="l00079"></a>00079                         <span class="keywordflow">if</span> (p == player[1]-&gt;player) {
<a name="l00080"></a>00080                                 owner = player2;
<a name="l00081"></a>00081                         } <span class="keywordflow">else</span> {
<a name="l00082"></a>00082                                 DEBUG_LOG(<span class="stringliteral">"%llu\tMULTI_GAME, PLAYER %d not exist, CMD %d, P1 %d, P2 %d"</span>, m_grp-&gt;id, p-&gt;id, cmd, player[0]-&gt;player-&gt;id, player[1]-&gt;player-&gt;id);
<a name="l00083"></a>00083                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00084"></a>00084                                         m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00085"></a>00085                                 }
<a name="l00086"></a>00086                                 <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00087"></a>00087                         }
<a name="l00088"></a>00088                 } <span class="keywordflow">else</span> {
<a name="l00089"></a>00089                         DEBUG_LOG(<span class="stringliteral">"%llu\tSINGLE_GAME, PLAYER %d not exist, CMD %d, P1 %d"</span>, m_grp-&gt;id, p-&gt;id, cmd, player[0]-&gt;player-&gt;id);
<a name="l00090"></a>00090                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00091"></a>00091                                 m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00092"></a>00092                         }
<a name="l00093"></a>00093                         <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00094"></a>00094                 }
<a name="l00095"></a>00095         } <span class="keywordflow">else</span> {
<a name="l00096"></a>00096                 DEBUG_LOG(<span class="stringliteral">"%llu\tCARD GAME has not STARTED, %d, CMD %d"</span>, m_grp-&gt;id, p-&gt;id, cmd);
<a name="l00097"></a>00097                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00098"></a>00098                         m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00099"></a>00099                 }
<a name="l00100"></a>00100                 <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00101"></a>00101         }
<a name="l00102"></a>00102         <span class="comment">/*</span>
<a name="l00103"></a>00103 <span class="comment">        if (p-&gt;id == player[0]-&gt;player-&gt;id) {</span>
<a name="l00104"></a>00104 <span class="comment">                owner = player1;</span>
<a name="l00105"></a>00105 <span class="comment">        } else {</span>
<a name="l00106"></a>00106 <span class="comment">                if ( player[1]-&gt;player != NULL) {</span>
<a name="l00107"></a>00107 <span class="comment">                        //it's multi game</span>
<a name="l00108"></a>00108 <span class="comment">                        if (p-&gt;id == player[1]-&gt;player-&gt;id) {</span>
<a name="l00109"></a>00109 <span class="comment">                                owner = player2;</span>
<a name="l00110"></a>00110 <span class="comment">                        } else {</span>
<a name="l00111"></a>00111 <span class="comment">                        //multi game, and it's not in this game</span>
<a name="l00112"></a>00112 <span class="comment">                        DEBUG_LOG("ERROR multi game player %d, cmd %d, group %llu", p-&gt;id, cmd, m_grp-&gt;id);</span>
<a name="l00113"></a>00113 <span class="comment">                        p-&gt;waitcmd = 0;</span>
<a name="l00114"></a>00114 <span class="comment">                        return GER_end_of_game;</span>
<a name="l00115"></a>00115 <span class="comment">                                </span>
<a name="l00116"></a>00116 <span class="comment">                        }</span>
<a name="l00117"></a>00117 <span class="comment">                } else {</span>
<a name="l00118"></a>00118 <span class="comment">                        //single game, and it's not in this game</span>
<a name="l00119"></a>00119 <span class="comment">                        DEBUG_LOG("ERROR single game player %d, cmd %d, group %llu", p-&gt;id, cmd, m_grp-&gt;id);</span>
<a name="l00120"></a>00120 <span class="comment">                        p-&gt;waitcmd = 0;</span>
<a name="l00121"></a>00121 <span class="comment">                        return GER_end_of_game;</span>
<a name="l00122"></a>00122 <span class="comment">                }</span>
<a name="l00123"></a>00123 <span class="comment">        }</span>
<a name="l00124"></a>00124 <span class="comment">        */</span>
<a name="l00125"></a>00125         <span class="keywordflow">switch</span> (cmd)
<a name="l00126"></a>00126         {
<a name="l00127"></a>00127                 <span class="keywordflow">case</span> card_game_start:
<a name="l00128"></a>00128                         <span class="keywordflow">if</span> (!CHALLENGE_GAME(m_grp-&gt;game)) {
<a name="l00129"></a>00129                                 ADD_TIMER_EVENT(p, on_timer_expire, 0, now.tv_sec + 120);
<a name="l00130"></a>00130                         }
<a name="l00131"></a>00131                         <span class="keywordflow">return</span> send_cards_array();
<a name="l00132"></a>00132                         <span class="keywordflow">break</span>;
<a name="l00133"></a>00133                 <span class="keywordflow">case</span> proto_player_action:
<a name="l00134"></a>00134                         MOD_EVENT_EXPIRE_TIME(p, on_timer_expire, now.tv_sec + 120);
<a name="l00135"></a>00135                         set_me_ready(player[owner]);
<a name="l00136"></a>00136                         <span class="keywordflow">return</span> processing(p, (<span class="keywordtype">int</span>)body[0]);
<a name="l00137"></a>00137                         <span class="keywordflow">break</span>;
<a name="l00138"></a>00138                 <span class="keywordflow">case</span> proto_player_leave:
<a name="l00139"></a>00139                 <span class="keywordflow">case</span> card_player_quit:
<a name="l00140"></a>00140                         DEBUG_LOG(<span class="stringliteral">"%llu\t%d LEAVE GAME %d"</span>, m_grp-&gt;id, p-&gt;id, cmd);
<a name="l00141"></a>00141                         <span class="comment">//中途离开</span>
<a name="l00142"></a>00142                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00143"></a>00143                                 m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00144"></a>00144                         }
<a name="l00145"></a>00145                         <span class="keywordflow">return</span> GER_player_request;
<a name="l00146"></a>00146                         <span class="keywordflow">break</span>;
<a name="l00147"></a>00147                 <span class="keywordflow">case</span> card_rival_ready:
<a name="l00148"></a>00148                         <span class="keywordflow">return</span> notify_rival_ready();
<a name="l00149"></a>00149                         <span class="keywordflow">break</span>;
<a name="l00150"></a>00150                 <span class="keywordflow">case</span> card_single_over:
<a name="l00151"></a>00151                         <span class="keywordflow">if</span> (player[player1]-&gt;rank &gt;= 9 &amp;&amp; final_winner == player1) {
<a name="l00152"></a>00152                                 get_item (p, <a class="code" href="card_8hpp.html#002c99a8ab1fabd71f1f44a471bd18aa">card_spec_item</a>);
<a name="l00153"></a>00153                         }
<a name="l00154"></a>00154                         <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00155"></a>00155                         <span class="keywordflow">break</span>;
<a name="l00156"></a>00156                 <span class="keywordflow">default</span>:
<a name="l00157"></a>00157                         DEBUG_LOG(<span class="stringliteral">"%llu\tCard, UNDEF cmd: %d"</span>, m_grp-&gt;id, cmd);
<a name="l00158"></a>00158                         <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160         <span class="comment">//game move on</span>
<a name="l00161"></a>00161         <span class="keywordflow">return</span> 0;
<a name="l00162"></a>00162 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="af30d52f74620a4c46106e44798cc691"></a><!-- doxytag: member="Card::handle_db_return" ref="af30d52f74620a4c46106e44798cc691" args="(sprite_t *p, uint32_t id, const void *buf, int len, uint32_t ret_code)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int Card::handle_db_return           </td>
          <td>(</td>
          <td class="paramtype">sprite_t *&nbsp;</td>
          <td class="paramname"> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&nbsp;</td>
          <td class="paramname"> <em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&nbsp;</td>
          <td class="paramname"> <em>ret_code</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
竞赛模式提交胜负后，处理数据库返回结果 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>@return</em>&nbsp;</td><td>GER_end_of_game 两个玩家都有返回或者错误才能结束 </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>0 两个玩家没有都返回 </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00292"></a>00292 {
<a name="l00293"></a>00293         <span class="keywordflow">if</span> (player[0] &amp;&amp; player[1]) {
<a name="l00294"></a>00294                 <span class="keywordflow">if</span> ( p == player[0]-&gt;player) {
<a name="l00295"></a>00295                         owner = player1;
<a name="l00296"></a>00296                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (player_num == multi_players) {
<a name="l00297"></a>00297                         <span class="keywordflow">if</span> (p == player[1]-&gt;player) {
<a name="l00298"></a>00298                                 owner = player2;
<a name="l00299"></a>00299                         } <span class="keywordflow">else</span> {
<a name="l00300"></a>00300                                 DEBUG_LOG(<span class="stringliteral">"%llu\tMULTI_GAME, db return , PLAYER %d not exist, waitcmd %d ret %d"</span>, m_grp-&gt;id, p-&gt;id, p-&gt;waitcmd, ret_code);
<a name="l00301"></a>00301                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00302"></a>00302                                         m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00303"></a>00303                                 }
<a name="l00304"></a>00304                                 <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00305"></a>00305                         }
<a name="l00306"></a>00306                 } <span class="keywordflow">else</span> {
<a name="l00307"></a>00307                         DEBUG_LOG(<span class="stringliteral">"%llu\tSINGLE_GAME, db return PLAYER %d not exist, waitcmd %d ret %d"</span>, m_grp-&gt;id, p-&gt;id, p-&gt;waitcmd, ret_code);
<a name="l00308"></a>00308                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00309"></a>00309                                 m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00310"></a>00310                         }
<a name="l00311"></a>00311                         <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00312"></a>00312                 }
<a name="l00313"></a>00313         } <span class="keywordflow">else</span> {
<a name="l00314"></a>00314                 DEBUG_LOG(<span class="stringliteral">"%llu\tCARD GAME has not STARTED, %d, waitcmd %d ret %d"</span>, m_grp-&gt;id, p-&gt;id, p-&gt;waitcmd, ret_code);
<a name="l00315"></a>00315                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00316"></a>00316                         m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00317"></a>00317                 }
<a name="l00318"></a>00318                 <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320         <span class="comment">/*</span>
<a name="l00321"></a>00321 <span class="comment">        if (p-&gt;id == player[0]-&gt;player-&gt;id) {</span>
<a name="l00322"></a>00322 <span class="comment">                owner = player1;</span>
<a name="l00323"></a>00323 <span class="comment">        } else {</span>
<a name="l00324"></a>00324 <span class="comment">                if ( player[1]-&gt;player != NULL) {</span>
<a name="l00325"></a>00325 <span class="comment">                        //it's multi game</span>
<a name="l00326"></a>00326 <span class="comment">                        if (p-&gt;id == player[1]-&gt;player-&gt;id) {</span>
<a name="l00327"></a>00327 <span class="comment">                                owner = player2;</span>
<a name="l00328"></a>00328 <span class="comment">                        } else {</span>
<a name="l00329"></a>00329 <span class="comment">                        //multi game, and it's not in this game</span>
<a name="l00330"></a>00330 <span class="comment">                        DEBUG_LOG("%llu\tERROR multi game player %d, db return", m_grp-&gt;id, p-&gt;id );</span>
<a name="l00331"></a>00331 <span class="comment">                        p-&gt;waitcmd = 0;</span>
<a name="l00332"></a>00332 <span class="comment">                        return GER_end_of_game;</span>
<a name="l00333"></a>00333 <span class="comment">                                </span>
<a name="l00334"></a>00334 <span class="comment">                        }</span>
<a name="l00335"></a>00335 <span class="comment">                } else {</span>
<a name="l00336"></a>00336 <span class="comment">                        //single game, and it's not in this game</span>
<a name="l00337"></a>00337 <span class="comment">                        DEBUG_LOG("%llu\tERROR single game player %d, db return", m_grp-&gt;id, p-&gt;id);</span>
<a name="l00338"></a>00338 <span class="comment">                        p-&gt;waitcmd = 0;</span>
<a name="l00339"></a>00339 <span class="comment">                        return GER_end_of_game;</span>
<a name="l00340"></a>00340 <span class="comment">                }</span>
<a name="l00341"></a>00341 <span class="comment">        }</span>
<a name="l00342"></a>00342 <span class="comment">        */</span>
<a name="l00343"></a>00343         DEBUG_LOG(<span class="stringliteral">"%llu\tcard:handle db return %d, ret %d"</span>, m_grp-&gt;id, p-&gt;id, ret_code);
<a name="l00344"></a>00344         <span class="keywordflow">switch</span>(p-&gt;waitcmd) {
<a name="l00345"></a>00345                 <span class="keywordflow">case</span> proto_card_add_win_lost:
<a name="l00346"></a>00346                         {
<a name="l00347"></a>00347                                 <span class="keywordflow">switch</span> (ret_code) {
<a name="l00348"></a>00348                                         <span class="keywordflow">case</span> 0:
<a name="l00349"></a>00349                                                 {
<a name="l00350"></a>00350                                                         <span class="keywordtype">int</span> rank_new = calculate_rank(player[owner]-&gt;p_cards_info);
<a name="l00351"></a>00351                                                         <span class="keywordflow">if</span> (rank_new &gt; player[owner]-&gt;rank) {
<a name="l00352"></a>00352                                                                 get_item(p, <a class="code" href="card_8hpp.html#ff1d762dba7709f5e46767d6393ee88c">rank_clothe</a>[rank_new]);
<a name="l00353"></a>00353                                                                 notify_get_item(p, <a class="code" href="card_8hpp.html#ff1d762dba7709f5e46767d6393ee88c">rank_clothe</a>[rank_new]);
<a name="l00354"></a>00354                                                                 DEBUG_LOG(<span class="stringliteral">"%llu\t%d RANK %d UP TO %d"</span>, m_grp-&gt;id, p-&gt;id, player[owner]-&gt;rank, rank_new);
<a name="l00355"></a>00355                                                         } 
<a name="l00356"></a>00356                                                 }
<a name="l00357"></a>00357                                                 <span class="keywordflow">break</span>;
<a name="l00358"></a>00358                                         <span class="keywordflow">case</span> 1147:
<a name="l00359"></a>00359                                                 <span class="comment">//experience limited</span>
<a name="l00360"></a>00360                                                 notify_exp_limited();
<a name="l00361"></a>00361                                                 <span class="keywordflow">break</span>;
<a name="l00362"></a>00362                                         <span class="keywordflow">default</span>:
<a name="l00363"></a>00363                                                 DEBUG_LOG(<span class="stringliteral">"%llu\tcard:handle db return UNDEF %d, ret %d"</span>, m_grp-&gt;id, p-&gt;id, ret_code);
<a name="l00364"></a>00364                                 }
<a name="l00365"></a>00365                                  
<a name="l00366"></a>00366                         }
<a name="l00367"></a>00367                         <span class="keywordflow">break</span>;
<a name="l00368"></a>00368                 <span class="keywordflow">default</span>:
<a name="l00369"></a>00369                         DEBUG_LOG(<span class="stringliteral">"%llu\tCard:: handle db return cmd UNDEF %d"</span>, m_grp-&gt;id, p-&gt;waitcmd);
<a name="l00370"></a>00370         }
<a name="l00371"></a>00371         return_cnt++;
<a name="l00372"></a>00372         <span class="comment">//get all return from db, end this game </span>
<a name="l00373"></a>00373         <span class="keywordflow">if</span> (return_cnt == player_num) {
<a name="l00374"></a>00374                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_grp-&gt;count; i++) {
<a name="l00375"></a>00375                         m_grp-&gt;players[i]-&gt;waitcmd = 0;
<a name="l00376"></a>00376                 }
<a name="l00377"></a>00377                 <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379         <span class="keywordflow">return</span> 0;
<a name="l00380"></a>00380 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="22cc18afb326153b46c32c177b3cc953"></a><!-- doxytag: member="Card::handle_timeout" ref="22cc18afb326153b46c32c177b3cc953" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int Card::handle_timeout           </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00226"></a>00226                                                {
<a name="l00227"></a>00227                         <span class="keywordflow">return</span> GER_end_of_game;
<a name="l00228"></a>00228                 }
</pre></div>
<p>

</div>
</div><p>
<hr>The documentation for this class was generated from the following files:<ul>
<li>E:/gameserv/games/cardgame/<a class="el" href="card_8hpp.html">card.hpp</a><li>E:/gameserv/games/cardgame/card.cpp</ul>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Feb 2 15:25:55 2009 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
